name: Deploy Cloudflare Worker (aurum-api)

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'worker/**'
      - 'wrangler.toml'
      - '.github/workflows/deploy-worker.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    name: Build and Deploy aurum-api Worker
    permissions:
      contents: read
      deployments: write  # For GitHub deployment status
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: worker/package.json

      - name: Install Wrangler CLI
        run: npm install -g wrangler@latest

      - name: Install Worker dependencies
        working-directory: worker
        run: npm ci

      - name: TypeScript type check
        working-directory: worker
        run: npx tsc --noEmit
        continue-on-error: true  # Don't fail on type errors, but warn

      - name: Deploy to Cloudflare Workers
        working-directory: worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.Cloudflare_API_Token }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.Cloudflare_Account_ID }}
        run: |
          echo "üöÄ Deploying aurum-api Worker to Cloudflare..."
          wrangler deploy --env production
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Worker deployed successfully!"
            echo "üåê URL: https://api.ah.saffronbolt.in"
          else
            echo "‚ùå Worker deployment failed"
            exit 1
          fi

      - name: Verify deployment
        run: |
          echo "üîç Verifying Worker deployment..."
          sleep 5  # Wait for deployment to propagate
          
          response=$(curl -s -w "\n%{http_code}" -X GET "https://api.ah.saffronbolt.in/health" || echo "000")
          http_code=$(echo "$response" | tail -n1)
          
          if [ "$http_code" -eq "200" ]; then
            echo "‚úÖ Worker is responding (HTTP $http_code)"
          else
            echo "‚ö†Ô∏è  Worker verification returned HTTP $http_code"
            echo "   This might be normal if health endpoint requires auth"
          fi

      - name: Create GitHub Deployment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'production',
              description: 'Deploy aurum-api Worker to Cloudflare',
              auto_merge: false,
              required_contexts: []
            });

